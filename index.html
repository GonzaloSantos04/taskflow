<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TaskFlow ‚Äî Google Tasks</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0a0a0f;--surface:#13131a;--surface2:#1c1c26;--border:#2a2a38;
    --accent:#7c6af7;--accent2:#f7c26a;--accent3:#6af7b8;--danger:#f76a6a;
    --text:#e8e8f0;--muted:#6b6b80;--high:#f76a6a;--med:#f7c26a;--low:#6af7b8;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(124,106,247,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(124,106,247,.04) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;}
  .app{position:relative;z-index:1;max-width:860px;margin:0 auto;padding:32px 20px 80px;}
  header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:36px;gap:16px;flex-wrap:wrap;}
  .logo{font-size:28px;font-weight:800;letter-spacing:-1px;}
  .logo span{color:var(--accent);}
  .logo-sub{font-size:12px;color:var(--muted);margin-top:4px;}
  .header-right{display:flex;flex-direction:column;align-items:flex-end;gap:8px;}
  .clock{font-family:'DM Mono',monospace;font-size:13px;color:var(--muted);text-align:right;line-height:1.6;}
  #date-display{color:var(--text);font-size:14px;}
  .header-btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}

  /* Auth */
  #auth-panel{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:48px 32px;text-align:center;margin-bottom:32px;}
  .auth-icon{font-size:52px;margin-bottom:16px;}
  .auth-title{font-size:24px;font-weight:800;margin-bottom:10px;}
  .auth-desc{color:var(--muted);font-size:14px;margin-bottom:28px;line-height:1.7;max-width:440px;margin-left:auto;margin-right:auto;}
  .auth-input-row{display:flex;gap:10px;max-width:520px;margin:0 auto 16px;flex-wrap:wrap;}
  .auth-input-row input{flex:1;min-width:200px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;padding:12px 16px;outline:none;transition:border-color .2s;}
  .auth-input-row input:focus{border-color:var(--accent);}
  .auth-input-row input::placeholder{color:var(--muted);}
  .auth-note{font-size:12px;color:var(--muted);line-height:1.6;}
  .auth-note a{color:var(--accent);text-decoration:none;}

  #dashboard{display:none;}

  .stats-bar{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;}
  .stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden;}
  .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
  .stat-card.s-total::before{background:var(--accent);}
  .stat-card.s-done::before{background:var(--accent3);}
  .stat-card.s-pending::before{background:var(--accent2);}
  .stat-card.s-overdue::before{background:var(--danger);}
  .stat-label{font-size:11px;font-weight:600;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
  .stat-value{font-size:32px;font-weight:800;letter-spacing:-1px;line-height:1;}
  .stat-card.s-done .stat-value{color:var(--accent3);}
  .stat-card.s-overdue .stat-value{color:var(--danger);}

  .progress-section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:28px;}
  .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .progress-title{font-size:13px;font-weight:600;letter-spacing:.5px;color:var(--muted);text-transform:uppercase;}
  .progress-pct{font-family:'DM Mono',monospace;font-size:20px;font-weight:500;color:var(--accent);}
  .progress-track{height:6px;background:var(--surface2);border-radius:99px;overflow:hidden;}
  .progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent3));border-radius:99px;transition:width .5s cubic-bezier(.4,0,.2,1);}

  .toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;gap:12px;flex-wrap:wrap;}
  .filter-bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
  .filter-label{font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
  .chip{background:var(--surface);border:1px solid var(--border);border-radius:99px;color:var(--muted);cursor:pointer;font-family:'Syne',sans-serif;font-size:12px;font-weight:600;padding:5px 14px;transition:all .15s;}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff;}
  .chip:hover:not(.active){border-color:var(--accent);color:var(--text);}
  .tasklist-selector{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:13px;padding:6px 12px;outline:none;cursor:pointer;}

  .add-form{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;}
  .form-title{font-size:13px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
  .form-row{display:flex;gap:10px;flex-wrap:wrap;}
  input[type=text],input[type=date],select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'Syne',sans-serif;font-size:14px;padding:10px 14px;outline:none;transition:border-color .2s;}
  input[type=text]:focus,input[type=date]:focus,select:focus{border-color:var(--accent);}
  input[type=text]::placeholder{color:var(--muted);}
  .input-task{flex:1;min-width:160px;}
  select option{background:var(--surface2);}

  .btn{border:none;border-radius:8px;cursor:pointer;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;letter-spacing:.5px;padding:10px 20px;transition:all .15s;white-space:nowrap;}
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-primary:hover{background:#9585ff;}
  .btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted);}
  .btn-outline:hover{border-color:var(--accent);color:var(--text);}
  .btn-sm{padding:7px 14px;font-size:12px;}
  .btn-notify{background:var(--surface2);border:1px solid var(--border);color:var(--muted);}
  .btn-notify.enabled{border-color:var(--accent3);color:var(--accent3);}

  .sync-bar{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);font-family:'DM Mono',monospace;}
  .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--accent3);animation:pulse 2s ease infinite;}
  .sync-dot.syncing{background:var(--accent2);animation:none;}
  .sync-dot.error{background:var(--danger);animation:none;}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

  .task-list{display:flex;flex-direction:column;gap:8px;}
  .task-item{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 18px;display:flex;align-items:center;gap:14px;transition:all .2s;animation:slideIn .25s ease;position:relative;overflow:hidden;}
  .task-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;}
  .task-item.p-high::before{background:var(--high);}
  .task-item.p-medium::before{background:var(--med);}
  .task-item.p-low::before{background:var(--low);}
  .task-item.done{opacity:.5;}
  .task-item.overdue{border-color:rgba(247,106,106,.3);}
  @keyframes slideIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
  .task-check{width:20px;height:20px;border:2px solid var(--border);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;background:transparent;}
  .task-check:hover{border-color:var(--accent3);}
  .task-check.checked{background:var(--accent3);border-color:var(--accent3);}
  .check-icon{display:none;color:#000;font-size:12px;font-weight:900;}
  .task-check.checked .check-icon{display:block;}
  .task-body{flex:1;min-width:0;}
  .task-name{font-size:15px;font-weight:600;margin-bottom:4px;}
  .done .task-name{text-decoration:line-through;color:var(--muted);}
  .task-meta{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
  .tag{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;padding:2px 8px;border-radius:4px;}
  .tag-priority-high{background:rgba(247,106,106,.15);color:var(--high);}
  .tag-priority-medium{background:rgba(247,194,106,.15);color:var(--med);}
  .tag-priority-low{background:rgba(106,247,184,.15);color:var(--low);}
  .tag-list{background:rgba(124,106,247,.15);color:var(--accent);}
  .tag-date{color:var(--muted);font-size:11px;}
  .tag-overdue{color:var(--danger);}
  .task-actions{display:flex;gap:6px;opacity:0;transition:opacity .15s;}
  .task-item:hover .task-actions{opacity:1;}
  .btn-icon{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;font-size:14px;padding:5px 8px;transition:all .15s;}
  .btn-icon:hover{border-color:var(--danger);color:var(--danger);}

  .empty{text-align:center;padding:60px 20px;color:var(--muted);}
  .empty-icon{font-size:40px;margin-bottom:12px;}
  .empty-text{font-size:14px;}
  .loading{text-align:center;padding:48px 20px;color:var(--muted);}
  .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 16px;}
  @keyframes spin{to{transform:rotate(360deg);}}

  .toast-container{position:fixed;bottom:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:10px;}
  .toast{background:var(--surface2);border:1px solid var(--accent);border-radius:12px;padding:14px 18px;max-width:300px;font-size:13px;animation:toastIn .3s ease;box-shadow:0 8px 32px rgba(124,106,247,.2);}
  .toast.t-success{border-color:var(--accent3);}
  .toast.t-error{border-color:var(--danger);}
  .toast-title{font-weight:700;font-size:12px;letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px;color:var(--accent);}
  .toast.t-success .toast-title{color:var(--accent3);}
  .toast.t-error .toast-title{color:var(--danger);}
  @keyframes toastIn{from{opacity:0;transform:translateY(16px) scale(.95);}to{opacity:1;transform:translateY(0) scale(1);}}

  @media(max-width:600px){
    .stats-bar{grid-template-columns:repeat(2,1fr);}
    .task-actions{opacity:1;}
  }
</style>
</head>
<body>
<div class="app">

  <header>
    <div>
      <div class="logo">Task<span>Flow</span></div>
      <div class="logo-sub">Sincronizado con Google Tasks</div>
    </div>
    <div class="header-right">
      <div class="clock">
        <div id="date-display"></div>
        <div id="time-display"></div>
      </div>
      <div class="header-btns">
        <button class="btn btn-notify btn-sm" id="notif-btn" onclick="toggleNotifications()">üîî Alertas</button>
        <button class="btn btn-outline btn-sm" id="logout-btn" onclick="logout()" style="display:none">Desconectar</button>
      </div>
    </div>
  </header>

  <!-- AUTH PANEL -->
  <div id="auth-panel">
    <div class="auth-icon">üîê</div>
    <div class="auth-title">Conecta Google Tasks</div>
    <div class="auth-desc">
      Ingresa tu <strong>Client ID de OAuth 2.0</strong> para sincronizar tus tareas en tiempo real.
      Funciona en m√≥vil y escritorio.
    </div>
    <div class="auth-input-row">
      <input type="text" id="client-id-input" placeholder="xxxxx.apps.googleusercontent.com">
      <button class="btn btn-primary" onclick="startAuth()">Conectar ‚Üí</button>
    </div>
    <div class="auth-note">
      Tu Client ID se guarda solo en tu dispositivo, nunca se env√≠a a ning√∫n servidor.
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard">
    <div class="stats-bar">
      <div class="stat-card s-total"><div class="stat-label">Total</div><div class="stat-value" id="stat-total">0</div></div>
      <div class="stat-card s-done"><div class="stat-label">Completadas</div><div class="stat-value" id="stat-done">0</div></div>
      <div class="stat-card s-pending"><div class="stat-label">Pendientes</div><div class="stat-value" id="stat-pending">0</div></div>
      <div class="stat-card s-overdue"><div class="stat-label">Vencidas</div><div class="stat-value" id="stat-overdue">0</div></div>
    </div>

    <div class="progress-section">
      <div class="progress-header">
        <span class="progress-title">Progreso general</span>
        <span class="progress-pct" id="progress-pct">0%</span>
      </div>
      <div class="progress-track"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>

    <div class="toolbar">
      <div class="sync-bar">
        <div class="sync-dot" id="sync-dot"></div>
        <span id="sync-status">Listo</span>
        <button class="btn btn-outline btn-sm" onclick="syncNow()" style="margin-left:8px">‚Üª Sync</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:12px;color:var(--muted)">Lista:</span>
        <select class="tasklist-selector" id="tasklist-select" onchange="onListChange()">
          <option value="">Todas las listas</option>
        </select>
      </div>
    </div>

    <div class="add-form">
      <div class="form-title">+ Nueva tarea</div>
      <div class="form-row">
        <input type="text" class="input-task" id="task-input" placeholder="¬øQu√© necesitas hacer?" onkeydown="if(event.key==='Enter')addTask()">
        <input type="date" id="date-input">
        <select id="priority-input">
          <option value="high">üî¥ Alta</option>
          <option value="medium" selected>üü° Media</option>
          <option value="low">üü¢ Baja</option>
        </select>
        <button class="btn btn-primary" onclick="addTask()">Agregar ‚Üí</button>
      </div>
    </div>

    <div class="filter-bar" style="margin-bottom:20px;">
      <span class="filter-label">Filtrar:</span>
      <span class="chip active" onclick="setFilter('all',this)">Todas</span>
      <span class="chip" onclick="setFilter('pending',this)">Pendientes</span>
      <span class="chip" onclick="setFilter('done',this)">Completadas</span>
      <span class="chip" onclick="setFilter('overdue',this)">Vencidas</span>
      <span class="chip" onclick="setFilter('high',this)">Alta</span>
      <span class="chip" onclick="setFilter('medium',this)">Media</span>
      <span class="chip" onclick="setFilter('low',this)">Baja</span>
    </div>

    <div class="task-list" id="task-list">
      <div class="loading"><div class="spinner"></div>Cargando tus tareas...</div>
    </div>
  </div>

</div>
<div class="toast-container" id="toast-container"></div>

<script src="https://apis.google.com/js/api.js"></script>
<script>
// ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REDIRECT_URI = 'https://gonzalosantos04.github.io/taskflow/';
const SCOPE = 'https://www.googleapis.com/auth/tasks';
const DISCOVERY = 'https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest';

let CLIENT_ID = localStorage.getItem('tf_client_id') || '';
let accessToken = null;
let tasks = [];
let taskLists = [];
let selectedListId = '';
let filter = 'all';
let notifEnabled = false;
let notifInterval = null;
let syncTimeout = null;

// ‚îÄ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.onload = () => {
  updateClock();
  setInterval(updateClock, 1000);
  document.getElementById('date-input').value = new Date().toISOString().split('T')[0];
  if (CLIENT_ID) document.getElementById('client-id-input').value = CLIENT_ID;

  // Check if we're returning from Google OAuth redirect
  const hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    const params = new URLSearchParams(hash.substring(1));
    const token = params.get('access_token');
    if (token) {
      accessToken = token;
      localStorage.setItem('tf_access_token', token);
      // Clean URL
      history.replaceState(null, '', REDIRECT_URI);
      showDashboard();
      waitForGapi().then(() => initGapi()).then(loadAllTasks);
      return;
    }
  }

  // Check saved token
  const saved = localStorage.getItem('tf_access_token');
  if (saved && CLIENT_ID) {
    accessToken = saved;
    showDashboard();
    waitForGapi().then(() => initGapi()).then(loadAllTasks);
  }
};

function waitForGapi(n=0) {
  return new Promise((res, rej) => {
    if (window.gapi) return res();
    if (n > 40) return rej('GAPI timeout');
    setTimeout(() => waitForGapi(n+1).then(res).catch(rej), 250);
  });
}

// ‚îÄ‚îÄ‚îÄ Auth ‚Äî redirect flow (works on mobile) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startAuth() {
  const val = document.getElementById('client-id-input').value.trim();
  if (!val) { showToast('‚ö†Ô∏è Falta', 'Ingresa tu Client ID', 'error'); return; }
  CLIENT_ID = val;
  localStorage.setItem('tf_client_id', CLIENT_ID);

  // Build Google OAuth URL (implicit / token flow)
  const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth');
  authUrl.searchParams.set('client_id', CLIENT_ID);
  authUrl.searchParams.set('redirect_uri', REDIRECT_URI);
  authUrl.searchParams.set('response_type', 'token');
  authUrl.searchParams.set('scope', SCOPE);
  authUrl.searchParams.set('prompt', 'select_account');

  // Redirect ‚Äî works on every device including mobile
  window.location.href = authUrl.toString();
}

function logout() {
  accessToken = null; tasks = []; taskLists = [];
  localStorage.removeItem('tf_access_token');
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('auth-panel').style.display = 'block';
  document.getElementById('logout-btn').style.display = 'none';
  showToast('üëã Desconectado', 'Sesi√≥n cerrada');
}

function showDashboard() {
  document.getElementById('auth-panel').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('logout-btn').style.display = 'inline-flex';
}

function initGapi() {
  return new Promise((res) => {
    gapi.load('client', async () => {
      await gapi.client.init({ discoveryDocs: [DISCOVERY] });
      gapi.client.setToken({ access_token: accessToken });
      res();
    });
  });
}

// ‚îÄ‚îÄ‚îÄ Load tasks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAllTasks() {
  setSyncing(true);
  try {
    const listsResp = await gapi.client.tasks.tasklists.list({ maxResults: 20 });
    taskLists = listsResp.result.items || [];
    populateListSelector();
    tasks = [];
    const toFetch = selectedListId ? taskLists.filter(l => l.id === selectedListId) : taskLists;
    for (const list of toFetch) {
      const resp = await gapi.client.tasks.tasks.list({
        tasklist: list.id, showCompleted: true, showHidden: true, maxResults: 100
      });
      const items = (resp.result.items || []).map(t => ({
        ...t,
        _listId: list.id,
        _listTitle: list.title,
        priority: (t.notes || '').match(/#(high|medium|low)/)?.[1] || 'medium'
      }));
      tasks.push(...items);
    }
    setSyncing(false);
    renderTasks(); updateStats(); checkOverdue();
    document.getElementById('sync-status').textContent =
      'Sync ' + new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(syncNow, 120000);
  } catch(err) {
    setSyncing(false, true);
    document.getElementById('sync-status').textContent = 'Error de conexi√≥n';
    showToast('‚ùå Error', 'No se pudo conectar con Google Tasks', 'error');
    if (err.status === 401) { localStorage.removeItem('tf_access_token'); logout(); }
  }
}

function syncNow() { showToast('üîÑ Sincronizando','Actualizando...'); loadAllTasks(); }

function setSyncing(a, err=false) {
  const d = document.getElementById('sync-dot');
  d.className = 'sync-dot' + (a?' syncing':err?' error':'');
}

function populateListSelector() {
  const sel = document.getElementById('tasklist-select');
  sel.innerHTML = '<option value="">Todas las listas</option>';
  taskLists.forEach(l => {
    const o = document.createElement('option');
    o.value = l.id; o.textContent = l.title;
    if (l.id === selectedListId) o.selected = true;
    sel.appendChild(o);
  });
}

function onListChange() {
  selectedListId = document.getElementById('tasklist-select').value;
  loadAllTasks();
}

async function addTask() {
  const name = document.getElementById('task-input').value.trim();
  if (!name) return;
  const date = document.getElementById('date-input').value;
  const priority = document.getElementById('priority-input').value;
  const listId = selectedListId || taskLists[0]?.id;
  if (!listId) { showToast('‚ö†Ô∏è','No hay listas disponibles','error'); return; }
  const body = { title: name, notes: `#${priority}`,
    ...(date && { due: new Date(date+'T12:00:00').toISOString() }) };
  try {
    await gapi.client.tasks.tasks.insert({ tasklist: listId, resource: body });
    document.getElementById('task-input').value = '';
    showToast('‚úÖ Creada', `"${name}" agregada`, 'success');
    await loadAllTasks();
  } catch(e) { showToast('‚ùå Error','No se pudo crear la tarea','error'); }
}

async function toggleDone(id, listId) {
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  const s = task.status === 'completed' ? 'needsAction' : 'completed';
  try {
    await gapi.client.tasks.tasks.patch({
      tasklist: listId, task: id,
      resource: { status: s, ...(s==='needsAction'&&{completed:null}) }
    });
    task.status = s;
    renderTasks(); updateStats();
    if (s==='completed') showToast('‚úÖ Lista',`"${task.title}" completada`,'success');
  } catch(e) { showToast('‚ùå Error','No se pudo actualizar','error'); }
}

async function deleteTask(id, listId) {
  const task = tasks.find(t => t.id === id);
  try {
    await gapi.client.tasks.tasks.delete({ tasklist: listId, task: id });
    tasks = tasks.filter(t => t.id !== id);
    renderTasks(); updateStats();
    if (task) showToast('üóëÔ∏è Eliminada',`"${task.title}" eliminada`);
  } catch(e) { showToast('‚ùå Error','No se pudo eliminar','error'); }
}

function setFilter(f, el) {
  filter = f;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderTasks();
}

function isOverdue(t) {
  if (!t.due || t.status==='completed') return false;
  return new Date(t.due) < new Date();
}

function getFiltered() {
  return tasks.filter(t => {
    if (filter==='all') return true;
    if (filter==='pending') return t.status!=='completed';
    if (filter==='done') return t.status==='completed';
    if (filter==='overdue') return isOverdue(t);
    if (filter==='high') return t.priority==='high'&&t.status!=='completed';
    if (filter==='medium') return t.priority==='medium'&&t.status!=='completed';
    if (filter==='low') return t.priority==='low'&&t.status!=='completed';
    return true;
  });
}

function formatDate(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleDateString('es-MX',{day:'2-digit',month:'short',year:'numeric'});
}

function renderTasks() {
  const list = document.getElementById('task-list');
  const filtered = getFiltered();
  if (!filtered.length) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üìã</div><div class="empty-text">No hay tareas aqu√≠</div></div>`;
    return;
  }
  list.innerHTML = filtered.map(t => {
    const done = t.status==='completed';
    const over = isOverdue(t);
    const dateStr = t.due ? `${over?'‚ö†Ô∏è Venci√≥':'üìÖ'} ${formatDate(t.due)}` : '';
    return `<div class="task-item p-${t.priority} ${done?'done':''} ${over?'overdue':''}">
      <div class="task-check ${done?'checked':''}" onclick="toggleDone('${t.id}','${t._listId}')">
        <span class="check-icon">‚úì</span>
      </div>
      <div class="task-body">
        <div class="task-name">${escHtml(t.title||'')}</div>
        <div class="task-meta">
          <span class="tag tag-priority-${t.priority}">${t.priority==='high'?'ALTA':t.priority==='medium'?'MEDIA':'BAJA'}</span>
          <span class="tag tag-list">üìã ${escHtml(t._listTitle)}</span>
          ${dateStr?`<span class="tag tag-date ${over?'tag-overdue':''}">${dateStr}</span>`:''}
        </div>
      </div>
      <div class="task-actions">
        <button class="btn-icon" onclick="deleteTask('${t.id}','${t._listId}')" title="Eliminar">‚úï</button>
      </div>
    </div>`;
  }).join('');
}

function updateStats() {
  const total = tasks.length;
  const done = tasks.filter(t=>t.status==='completed').length;
  const pending = tasks.filter(t=>t.status!=='completed').length;
  const overdue = tasks.filter(t=>isOverdue(t)).length;
  const pct = total ? Math.round(done/total*100) : 0;
  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-done').textContent = done;
  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-overdue').textContent = overdue;
  document.getElementById('progress-pct').textContent = pct+'%';
  document.getElementById('progress-fill').style.width = pct+'%';
}

async function toggleNotifications() {
  if (!notifEnabled) {
    if (!('Notification' in window)) { showToast('‚ö†Ô∏è','No soportado','error'); return; }
    const p = await Notification.requestPermission();
    if (p==='granted') {
      notifEnabled = true;
      document.getElementById('notif-btn').classList.add('enabled');
      document.getElementById('notif-btn').textContent = 'üîî ON';
      showToast('üîî Activadas','Te avisaremos de tareas vencidas','success');
      notifInterval = setInterval(checkOverdue, 60000);
    } else { showToast('‚ùå Denegadas','Permite notificaciones en tu navegador','error'); }
  } else {
    notifEnabled = false;
    document.getElementById('notif-btn').classList.remove('enabled');
    document.getElementById('notif-btn').textContent = 'üîî Alertas';
    clearInterval(notifInterval);
    showToast('üîï Desactivadas','Notificaciones apagadas');
  }
}

function checkOverdue() {
  if (!notifEnabled) return;
  const ov = tasks.filter(t=>isOverdue(t));
  if (ov.length) new Notification('‚ö†Ô∏è TaskFlow',{body:`${ov.length} tarea(s) vencidas sin completar.`});
}

function updateClock() {
  const now = new Date();
  const days=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  const months=['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  document.getElementById('date-display').textContent =
    `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
  document.getElementById('time-display').textContent =
    now.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function showToast(title, msg, type='') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = 'toast'+(type?' t-'+type:'');
  t.innerHTML = `<div class="toast-title">${title}</div>${msg}`;
  c.appendChild(t);
  setTimeout(()=>t.remove(), 3800);
}
</script>
</body>
</html>
